name: éªŒè¯æ–‡æ¡£é“¾æ¥å®‰å…¨æ€§

on:
  # åœ¨PRå’Œpushåˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - '**.md'
      - 'scripts/validate-links.py'
      - '.github/workflows/validate-docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.md'
      - 'scripts/validate-links.py'
      - '.github/workflows/validate-docs.yml'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  validate-links:
    name: éªŒè¯æ–‡æ¡£é“¾æ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ä½¿è„šæœ¬å¯æ‰§è¡Œ
        run: chmod +x scripts/validate-links.py
        
      - name: éªŒè¯æ–‡æ¡£é“¾æ¥å®‰å…¨æ€§
        run: |
          echo "ğŸš€ å¼€å§‹éªŒè¯æ–‡æ¡£é“¾æ¥å®‰å…¨æ€§..."
          python3 scripts/validate-links.py
          
      - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: link-validation-report
          path: |
            *.md
            scripts/validate-links.py
          retention-days: 30

  # é¢å¤–çš„å®‰å…¨æ£€æŸ¥job
  security-check:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
        run: |
          echo "ğŸ” æ£€æŸ¥æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯..."
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«å¯†é’¥ã€å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
          if grep -rE "(password|secret|key|token)[:=]\s*['\"][^'\"]{8,}['\"]" *.md; then
            echo "âŒ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«çœŸå®çš„APIå¯†é’¥æ ¼å¼
          if grep -rE "(sk-[a-zA-Z0-9]{48}|AIza[0-9A-Za-z_-]{35})" *.md; then
            echo "âŒ å‘ç°å¯èƒ½çš„APIå¯†é’¥"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«çœŸå®IPåœ°å€ï¼ˆæ’é™¤ç¤ºä¾‹IPï¼‰
          if grep -rE "([0-9]{1,3}\.){3}[0-9]{1,3}" *.md | grep -v -E "(127\.|192\.168\.|10\.|172\.1[6-9]\.|172\.2[0-9]\.|172\.3[0-1]\.|0\.0\.0\.0|255\.255\.255\.255|example|demo|test)" ; then
            echo "âš ï¸  å‘ç°çœŸå®IPåœ°å€ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¸ºç¤ºä¾‹"
            # ä¸é€€å‡ºï¼Œåªæ˜¯è­¦å‘Š
          fi
          
          echo "âœ… æ•æ„Ÿä¿¡æ¯æ£€æŸ¥é€šè¿‡"
          
      - name: æ£€æŸ¥æ¶æ„è„šæœ¬
        run: |
          echo "ğŸ›¡ï¸  æ£€æŸ¥æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å«æ¶æ„è„šæœ¬..."
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«å¯ç–‘çš„è„šæœ¬æ ‡ç­¾
          if grep -rE "<script[^>]*>" *.md; then
            echo "âŒ å‘ç°scriptæ ‡ç­¾ï¼Œå¯èƒ½åŒ…å«æ¶æ„è„šæœ¬"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«javascript: åè®®
          if grep -rE "javascript:" *.md; then
            echo "âŒ å‘ç°javascript:åè®®ï¼Œå¯èƒ½æœ‰å®‰å…¨é£é™©"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«data: åè®®çš„å¯ç–‘å†…å®¹
          if grep -rE "data:[^,]*script" *.md; then
            echo "âŒ å‘ç°å¯ç–‘çš„data:åè®®å†…å®¹"
            exit 1
          fi
          
          echo "âœ… æ¶æ„è„šæœ¬æ£€æŸ¥é€šè¿‡"