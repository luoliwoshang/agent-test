name: Keep Render Service Alive

on:
  schedule:
    # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (GitHub Actions æœ€å°é—´éš”)
    - cron: '*/5 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  ping-service:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Render Service
        run: |
          echo "ğŸƒâ€â™‚ï¸ å¼€å§‹ ping Render æœåŠ¡..."
          echo "ğŸ• å½“å‰æ—¶é—´: $(date)"
          
          # ping å¥åº·æ£€æŸ¥ç«¯ç‚¹
          response=$(curl -s -o /dev/null -w "%{http_code}" https://agent-test-n6lr.onrender.com/health || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… æœåŠ¡æ­£å¸¸è¿è¡Œ (HTTP $response)"
          elif [ "$response" = "000" ]; then
            echo "âš ï¸  ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•..."
            sleep 10
            response=$(curl -s -o /dev/null -w "%{http_code}" https://agent-test-n6lr.onrender.com/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… é‡è¯•æˆåŠŸï¼ŒæœåŠ¡å·²å”¤é†’ (HTTP $response)"
            else
              echo "âŒ æœåŠ¡æ— å“åº” (HTTP $response)"
              exit 1
            fi
          else
            echo "âš ï¸  æœåŠ¡è¿”å›é 200 çŠ¶æ€ç : HTTP $response"
            echo "å¯èƒ½æ˜¯æœåŠ¡æ­£åœ¨å¯åŠ¨ä¸­..."
          fi
          
          echo "ğŸ¯ Keep-alive ä»»åŠ¡å®Œæˆ"

      - name: Test Webhook Endpoint
        run: |
          echo "ğŸ”— æµ‹è¯• webhook ç«¯ç‚¹å¯è¾¾æ€§..."
          
          # æµ‹è¯• webhook ç«¯ç‚¹ (åº”è¯¥è¿”å› 405 Method Not Allowedï¼Œå› ä¸ºæˆ‘ä»¬ç”¨ GET è€Œä¸æ˜¯ POST)
          response=$(curl -s -o /dev/null -w "%{http_code}" https://agent-test-n6lr.onrender.com/webhook || echo "000")
          
          if [ "$response" = "405" ]; then
            echo "âœ… Webhook ç«¯ç‚¹æ­£å¸¸ (HTTP $response - Method Not Allowed ç¬¦åˆé¢„æœŸ)"
          elif [ "$response" = "200" ]; then
            echo "âœ… Webhook ç«¯ç‚¹å¯è¾¾ (HTTP $response)"
          else
            echo "âš ï¸  Webhook ç«¯ç‚¹çŠ¶æ€: HTTP $response"
          fi

      - name: Log Service Status
        run: |
          echo "ğŸ“Š æœåŠ¡çŠ¶æ€æŠ¥å‘Š:"
          echo "â€¢ æ—¶é—´: $(date)"
          echo "â€¢ å¥åº·æ£€æŸ¥: https://agent-test-n6lr.onrender.com/health"
          echo "â€¢ Webhook ç«¯ç‚¹: https://agent-test-n6lr.onrender.com/webhook"
          echo "â€¢ ä¸‹æ¬¡æ£€æŸ¥: 15 åˆ†é’Ÿå"